<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Game Loop Builder</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0a0c12;--panel:#111520;--panel2:#181e2d;
  --border:#252f45;--border2:#2e3d5c;
  --accent:#4d8bff;--gold:#f5a623;
  --green:#2ed573;--red:#ff4757;
  --text:#dde3f0;--text-dim:#6b7a9e;--text-dimmer:#3d4e6e;
}
body{font-family:'Rajdhani',sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden;display:flex;flex-direction:column}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}

header{background:var(--panel);border-bottom:2px solid var(--border2);padding:0 20px;display:flex;align-items:center;gap:16px;height:52px;flex-shrink:0}
.logo{font-family:'Orbitron',monospace;font-size:17px;font-weight:900;letter-spacing:3px;background:linear-gradient(135deg,var(--accent),#a855f7);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.logo-sub{font-size:10px;letter-spacing:4px;color:var(--text-dim);font-weight:600}
.header-sep{flex:1}
.game-name-input{background:transparent;border:none;border-bottom:1px solid var(--border2);color:var(--text);font-family:'Orbitron',monospace;font-size:13px;font-weight:600;letter-spacing:2px;padding:4px 8px;outline:none;width:240px;text-align:center}
.game-name-input::placeholder{color:var(--text-dimmer);font-size:11px}
.btn{padding:8px 20px;border:none;border-radius:6px;cursor:pointer;font-family:'Rajdhani',sans-serif;font-weight:700;font-size:13px;letter-spacing:1px;transition:all .2s}
.btn:hover{opacity:.85;transform:translateY(-1px)}
.btn-render{background:linear-gradient(135deg,var(--accent),#7c3aed);color:#fff}
.btn-download{background:linear-gradient(135deg,#16a34a,#15803d);color:#fff}

.main{display:flex;flex:1;overflow:hidden}

.left{width:460px;min-width:460px;background:var(--panel);border-right:2px solid var(--border2);display:flex;flex-direction:column;overflow:hidden}
.tabs{display:flex;border-bottom:1px solid var(--border)}
.tab{flex:1;padding:11px 6px;text-align:center;font-size:12px;font-weight:700;letter-spacing:1.5px;cursor:pointer;color:var(--text-dim);border-bottom:2px solid transparent;transition:all .2s;text-transform:uppercase}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);background:rgba(77,139,255,.05)}
.tab-content{display:none;flex-direction:column;overflow-y:auto;padding:14px;gap:10px;flex:1}
.tab-content.active{display:flex}

.sec-title{font-size:10px;font-weight:700;letter-spacing:2px;color:var(--accent);text-transform:uppercase;padding:4px 0 8px;border-bottom:1px solid var(--border)}
.btn-sm{padding:7px 14px;border-radius:5px;font-size:12px;letter-spacing:.5px;cursor:pointer;border:none;font-family:'Rajdhani',sans-serif;font-weight:700;transition:all .2s}
.btn-add{background:var(--accent);color:#fff}
.btn-add:hover{background:#3a77ee}
.btn-danger{background:transparent;color:var(--red);border:1px solid var(--red);padding:3px 7px;font-size:10px;border-radius:3px;cursor:pointer;font-family:'Rajdhani',sans-serif;font-weight:600;transition:all .2s}
.btn-danger:hover{background:rgba(255,71,87,.1)}

.elem-table{width:100%;border-collapse:collapse;font-size:12px}
.elem-table th{background:var(--panel2);color:var(--text-dim);padding:7px 8px;text-align:left;font-weight:700;letter-spacing:.5px;font-size:10px;border-bottom:1px solid var(--border);text-transform:uppercase}
.elem-table td{padding:6px 8px;border-bottom:1px solid var(--border);vertical-align:middle}
.elem-table tr:hover td{background:rgba(255,255,255,.02)}
.type-badge{display:inline-block;padding:2px 8px;border-radius:3px;font-size:10px;font-weight:700;letter-spacing:.5px}
.t-system{background:#0d2440;color:#5ba0ff}
.t-resource{background:#0d2e14;color:#4ef580}
.t-action{background:#2a2200;color:#ffd070}
.elem-thumb{width:30px;height:30px;border-radius:5px;object-fit:cover;background:var(--panel2);border:1px solid var(--border)}
.elem-thumb-ph{width:30px;height:30px;border-radius:5px;background:var(--panel2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:14px;color:var(--text-dimmer)}
.empty-msg{color:var(--text-dimmer);font-size:12px;text-align:center;padding:20px;border:1px dashed var(--border);border-radius:6px}

.form-group{display:flex;flex-direction:column;gap:5px}
.form-group label{font-size:11px;font-weight:600;color:var(--text-dim);letter-spacing:.5px}
.form-ctrl{background:var(--panel2);border:1px solid var(--border);border-radius:5px;padding:7px 10px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:13px;outline:none;transition:border-color .2s;width:100%}
.form-ctrl:focus{border-color:var(--accent)}
select.form-ctrl option{background:var(--panel2)}
.form-row{display:flex;gap:8px}
.form-row .form-group{flex:1}
.icon-upload-area{border:2px dashed var(--border2);border-radius:8px;padding:12px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:12px}
.icon-upload-area:hover{border-color:var(--accent);background:rgba(77,139,255,.05)}
.icon-preview{width:50px;height:50px;border-radius:7px;object-fit:cover;border:1px solid var(--border);display:none}
.icon-preview.visible{display:block}
.icon-upload-label{font-size:12px;color:var(--text-dim)}
.icon-upload-label span{color:var(--accent);font-weight:600}

.loop-row{background:var(--panel2);border:1px solid var(--border);border-radius:8px;padding:10px;display:flex;flex-direction:column;gap:8px}
.loop-row.disabled{opacity:.4}
.loop-row-head{display:flex;align-items:center;gap:8px}
.loop-num{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;flex-shrink:0;background:var(--accent)}
.loop-pos-label{font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;padding:2px 8px;border-radius:3px;background:var(--panel);color:var(--text-dim)}
.loop-toggle{margin-left:auto;cursor:pointer;font-size:10px;font-weight:600;letter-spacing:.5px;padding:3px 10px;border-radius:3px;border:1px solid var(--border2);background:transparent;color:var(--text-dim);transition:all .2s;font-family:'Rajdhani',sans-serif}
.loop-toggle.on{border-color:var(--green);color:var(--green);background:rgba(46,213,115,.08)}
.loop-fields{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.loop-field{display:flex;flex-direction:column;gap:3px}
.loop-field label{font-size:10px;color:var(--text-dim);font-weight:700;letter-spacing:.5px}
.lf-opt{color:var(--text-dimmer);font-size:9px;font-style:italic;margin-left:3px}

.multi-sel{background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:4px;min-height:32px}
.multi-tags{display:flex;flex-wrap:wrap;gap:3px;align-items:center}
.m-tag{background:var(--panel);border:1px solid var(--border2);border-radius:3px;padding:2px 6px;font-size:10px;display:flex;align-items:center;gap:3px}
.m-tag img{width:14px;height:14px;border-radius:2px;object-fit:cover}
.m-tag .rm{cursor:pointer;color:var(--red);font-size:11px;line-height:1}
.m-add-btn{font-size:10px;color:var(--accent);cursor:pointer;padding:2px 6px;border:1px dashed var(--border2);border-radius:3px;white-space:nowrap;transition:border .15s}
.m-add-btn:hover{border-color:var(--accent)}
.single-sel{background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:4px 8px;height:32px;cursor:pointer;display:flex;align-items:center;gap:6px;transition:border .15s;font-size:11px}
.single-sel:hover{border-color:var(--border2)}
.ss-icon{width:18px;height:18px;border-radius:3px;object-fit:cover}
.ss-name{flex:1;color:var(--text)}
.ss-ph{flex:1;color:var(--text-dimmer)}
.ss-clear{color:var(--red);font-size:12px;cursor:pointer;padding:0 2px}

.dropdown-popup{position:fixed;background:var(--panel);border:1px solid var(--border2);border-radius:6px;z-index:500;box-shadow:0 8px 32px rgba(0,0,0,.6);overflow:hidden;min-width:160px;max-height:220px;overflow-y:auto}
.dp-item{display:flex;align-items:center;gap:8px;padding:8px 10px;cursor:pointer;font-size:12px;transition:background .12s}
.dp-item:hover{background:rgba(77,139,255,.12)}
.dp-item img{width:22px;height:22px;border-radius:4px;object-fit:cover}
.dp-ph{width:22px;height:22px;border-radius:4px;background:var(--panel2);display:flex;align-items:center;justify-content:center;font-size:12px}
.dp-empty{padding:12px;font-size:11px;color:var(--text-dimmer);text-align:center}
.dp-remove{padding:7px 10px;font-size:11px;color:var(--red);cursor:pointer;border-top:1px solid var(--border)}
.dp-remove:hover{background:rgba(255,71,87,.1)}

.right{flex:1;display:flex;flex-direction:column;background:var(--bg);overflow:hidden}
.preview-bar{background:var(--panel);border-bottom:1px solid var(--border);padding:10px 20px;display:flex;align-items:center;gap:12px;flex-shrink:0}
.preview-bar-title{font-family:'Orbitron',monospace;font-size:11px;letter-spacing:2px;color:var(--text-dim)}
.scale-wrap{display:flex;align-items:center;gap:8px;font-size:11px;color:var(--text-dim)}
.scale-input{background:var(--panel2);border:1px solid var(--border);border-radius:4px;padding:3px 6px;color:var(--text);width:55px;font-size:12px;outline:none;text-align:center}
.preview-wrap{flex:1;overflow:auto;display:flex;align-items:flex-start;justify-content:flex-start;padding:24px;background:radial-gradient(ellipse at center,#0e1425 0%,#0a0c12 70%)}
canvas{display:block;border-radius:6px;box-shadow:0 4px 40px rgba(0,0,0,.7)}
</style>
</head>
<body>

<header>
  <div>
    <div class="logo">GAME LOOP</div>
    <div class="logo-sub">BUILDER</div>
  </div>
  <div class="header-sep"></div>
  <input class="game-name-input" id="gameName" placeholder="NOMBRE DEL JUEGO" value="MY GAME">
  <button class="btn btn-render" onclick="renderCanvas()">‚ö° RENDERIZAR</button>
  <button class="btn btn-download" onclick="downloadCanvas()">‚¨á DESCARGAR PNG</button>
</header>

<div class="main">
  <div class="left">
    <div class="tabs">
      <div class="tab active" onclick="switchTab('elements')">üé® Elementos</div>
      <div class="tab" onclick="switchTab('loop')">üîÑ Game Loop</div>
    </div>

    <div class="tab-content active" id="tab-elements">
      <div class="sec-title">Crear Elemento</div>
      <div class="form-row">
        <div class="form-group">
          <label>NOMBRE</label>
          <input class="form-ctrl" id="newName" placeholder="Soft Currency..." maxlength="24">
        </div>
        <div class="form-group">
          <label>TIPO</label>
          <select class="form-ctrl" id="newType">
            <option value="system">Sistema</option>
            <option value="resource">Recurso</option>
            <option value="action">Acci√≥n</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>ICONO (imagen cuadrada)</label>
        <div class="icon-upload-area" onclick="document.getElementById('iconFile').click()">
          <img class="icon-preview" id="iconPreview">
          <div>
            <div class="icon-upload-label"><span>Clic para subir</span> imagen de icono</div>
            <div style="font-size:10px;color:var(--text-dimmer);margin-top:3px">PNG, JPG</div>
          </div>
        </div>
        <input type="file" id="iconFile" accept="image/*" style="display:none" onchange="previewIcon(event)">
      </div>
      <button class="btn-sm btn-add" onclick="addElement()" style="align-self:flex-start">+ A√±adir Elemento</button>

      <div class="sec-title" style="margin-top:4px">Elementos Creados</div>
      <div id="elementsContainer">
        <div class="empty-msg">Sin elementos a√∫n.<br>Crea los primeros arriba.</div>
      </div>
    </div>

    <div class="tab-content" id="tab-loop">
      <div class="sec-title" style="font-size:9px">8 sistemas disponibles ¬∑ activa los que quieras usar</div>
      <div id="loopRowsContainer"></div>
    </div>
  </div>

  <div class="right">
    <div class="preview-bar">
      <span class="preview-bar-title">PREVIEW</span>
      <div class="scale-wrap">
        <span>Zoom</span>
        <input class="scale-input" id="scaleInput" type="number" value="70" min="20" max="150" step="5" onchange="applyScale()">
        <span>%</span>
      </div>
      <div style="flex:1"></div>
      <span style="font-size:11px;color:var(--text-dimmer)">1600 √ó 900 px</span>
    </div>
    <div class="preview-wrap" id="previewWrap">
      <canvas id="gameCanvas" width="1600" height="900"></canvas>
    </div>
  </div>
</div>

<div class="dropdown-popup" id="dropdownPopup" style="display:none"></div>

<script>
// ==================== CONSTANTS ====================
const CANVAS_W=1600, CANVAS_H=900;
const TITLE_H=62;
const CX=CANVAS_W/2, CY=490;

const NODE_S=72, BOX_H=72, ICON_S=48, ITEM_W=64, BOX_PAD=14, GAP=20;
const PLAYER_R=54;
const OUTER_MARGIN=44;   // how close to canvas edge the return lane goes
const PLAYER_STOP=18;    // extra gap between return arrow tip and player circle

const C_BLACK='#222222', C_RED='#cc2200', C_GREEN='#007a35';
const C_BLUE='#1655cc', C_AMBER='#b86e00';

// ==================== STATE ====================
let elements=[], nextId=1, currentIconData=null;

const ROW_CONFIGS=[
  {label:'TL-1',side:'left', y:175},
  {label:'TL-2',side:'left', y:340},
  {label:'TR-1',side:'right',y:175},
  {label:'TR-2',side:'right',y:340},
  {label:'BR-1',side:'right',y:645},
  {label:'BR-2',side:'right',y:810},
  {label:'BL-1',side:'left', y:645},
  {label:'BL-2',side:'left', y:810},
];

let loopRows=ROW_CONFIGS.map((_,i)=>({index:i,enabled:false,systemId:null,costIds:[],actionId:null,rewardIds:[]}));

// ==================== ELEMENTS ====================
const TYPE_LABELS={system:'Sistema',resource:'Recurso',action:'Acci√≥n'};
const TYPE_BADGES={system:'t-system',resource:'t-resource',action:'t-action'};

function getElementIconSrc(elem){
  return elem.iconData||elem.iconPath||'';
}

function createElementImage(src){
  if(!src) return null;
  const img=new Image();
  img.src=src;
  return img;
}

async function loadDefaultElements(){
  try{
    const res=await fetch('./data/elements.json');
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const defaults=await res.json();
    if(!Array.isArray(defaults)) throw new Error('Formato inv√°lido: se esperaba un array');

    defaults.forEach(item=>{
      if(!item||typeof item!=='object') return;
      const name=typeof item.name==='string'?item.name.trim():'';
      const type=typeof item.type==='string'?item.type:'';
      if(!name||!TYPE_LABELS[type]) return;

      const iconPath=typeof item.icon==='string'&&item.icon.trim()?item.icon.trim():null;
      const elem={
        id:nextId++,
        name,
        type,
        iconPath,
        iconData:null,
        imgObj:createElementImage(iconPath)
      };
      elements.push(elem);
    });
  }catch(err){
    console.warn('No se pudieron cargar los elementos por defecto:',err);
  }
}

function previewIcon(e){
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{
    currentIconData=ev.target.result;
    const p=document.getElementById('iconPreview');
    p.src=currentIconData; p.classList.add('visible');
  };
  r.readAsDataURL(f);
}

function addElement(){
  const name=document.getElementById('newName').value.trim();
  const type=document.getElementById('newType').value;
  if(!name){alert('Introduce un nombre'); return;}
  const elem={id:nextId++,name,type,iconPath:null,iconData:currentIconData,imgObj:createElementImage(currentIconData)};
  elements.push(elem);
  currentIconData=null;
  document.getElementById('newName').value='';
  document.getElementById('iconPreview').classList.remove('visible');
  document.getElementById('iconFile').value='';
  renderElementsTable(); renderLoopRows();
}

function removeElement(id){
  elements=elements.filter(e=>e.id!==id);
  loopRows.forEach(row=>{
    if(row.systemId===id) row.systemId=null;
    if(row.actionId===id) row.actionId=null;
    row.costIds=row.costIds.filter(x=>x!==id);
    row.rewardIds=row.rewardIds.filter(x=>x!==id);
  });
  renderElementsTable(); renderLoopRows();
}

function getElem(id){return elements.find(e=>e.id===id)||null}

function renderElementsTable(){
  const c=document.getElementById('elementsContainer');
  if(!elements.length){c.innerHTML='<div class="empty-msg">Sin elementos a√∫n.</div>'; return;}
  c.innerHTML=`<table class="elem-table">
    <tr><th>Icono</th><th>Nombre</th><th>Tipo</th><th></th></tr>
    ${elements.map(e=>`<tr>
      <td>${getElementIconSrc(e)?`<img class="elem-thumb" src="${getElementIconSrc(e)}">`:'<div class="elem-thumb-ph">?</div>'}</td>
      <td style="font-weight:600;font-size:13px">${e.name}</td>
      <td><span class="type-badge ${TYPE_BADGES[e.type]}">${TYPE_LABELS[e.type]}</span></td>
      <td><button class="btn-danger" onclick="removeElement(${e.id})">‚úï</button></td>
    </tr>`).join('')}
  </table>`;
}

// ==================== LOOP ROWS UI ====================
function renderLoopRows(){
  const c=document.getElementById('loopRowsContainer');
  c.innerHTML=loopRows.map((row,i)=>{
    const cfg=ROW_CONFIGS[i], on=row.enabled;
    return `<div class="loop-row${on?'':' disabled'}">
      <div class="loop-row-head">
        <div class="loop-num">${i+1}</div>
        <span class="loop-pos-label">${cfg.label} ¬∑ ${cfg.side==='left'?'IZQ':'DER'}</span>
        <button class="loop-toggle${on?' on':''}" onclick="toggleRow(${i})">${on?'‚óè ON':'‚óã OFF'}</button>
      </div>
      ${on?`<div class="loop-fields">
        <div class="loop-field">
          <label>üîµ SISTEMA</label>
          ${ssHtml(i,'system',row.systemId,'system')}
        </div>
        <div class="loop-field">
          <label>üü° ACCI√ìN</label>
          ${ssHtml(i,'action',row.actionId,'action')}
        </div>
        <div class="loop-field" style="grid-column:1/-1">
          <label>üî¥ COSTES<span class="lf-opt"> ‚Äî recursos (m√∫ltiple)</span></label>
          ${msHtml(i,'cost',row.costIds,'resource')}
        </div>
        <div class="loop-field" style="grid-column:1/-1">
          <label>üü¢ RECOMPENSAS<span class="lf-opt"> ‚Äî recursos (m√∫ltiple)</span></label>
          ${msHtml(i,'reward',row.rewardIds,'resource')}
        </div>
      </div>`:''}
    </div>`;
  }).join('');
}

function ssHtml(ri,field,selId,type){
  const el=selId?getElem(selId):null;
  return `<div class="single-sel" onclick="openSingle(event,${ri},'${field}','${type}')">
    ${el?`${getElementIconSrc(el)?`<img class="ss-icon" src="${getElementIconSrc(el)}">`:''}
      <span class="ss-name">${el.name}</span>
      <span class="ss-clear" onclick="event.stopPropagation();clearSS(${ri},'${field}')">‚úï</span>`
    :`<span class="ss-ph">Seleccionar...</span>`}
  </div>`;
}

function msHtml(ri,field,ids,type){
  const elems=ids.map(id=>getElem(id)).filter(Boolean);
  return `<div class="multi-sel">
    <div class="multi-tags">
      ${elems.map(e=>`<div class="m-tag">
        ${getElementIconSrc(e)?`<img src="${getElementIconSrc(e)}">`:''}
        <span>${e.name}</span>
        <span class="rm" onclick="removeMs(${ri},'${field}',${e.id})">‚úï</span>
      </div>`).join('')}
      <div class="m-add-btn" onclick="openMulti(event,${ri},'${field}','${type}')">+ A√±adir</div>
    </div>
  </div>`;
}

function toggleRow(i){loopRows[i].enabled=!loopRows[i].enabled; renderLoopRows();}
function clearSS(ri,f){loopRows[ri][f+'Id']=null; renderLoopRows();}
function removeMs(ri,f,id){loopRows[ri][f+'Ids']=loopRows[ri][f+'Ids'].filter(x=>x!==id); renderLoopRows();}

// ==================== DROPDOWN ====================
function openSingle(event,ri,f,type){
  event.stopPropagation();
  const pp=document.getElementById('dropdownPopup');
  const filtered=elements.filter(e=>e.type===type);
  const rect=event.currentTarget.getBoundingClientRect();
  pp.innerHTML=`${!filtered.length?`<div class="dp-empty">Sin ${TYPE_LABELS[type]}</div>`:''}
    ${filtered.map(e=>`<div class="dp-item" onclick="setSS(${ri},'${f}',${e.id})">
      ${getElementIconSrc(e)?`<img src="${getElementIconSrc(e)}">`:'<div class="dp-ph">?</div>'}
      <span>${e.name}</span></div>`).join('')}
    <div class="dp-remove" onclick="clearSS(${ri},'${f}');closeDD()">‚úï Limpiar</div>`;
  posDD(pp,rect);
}

function openMulti(event,ri,f,type){
  event.stopPropagation();
  const pp=document.getElementById('dropdownPopup');
  const sel=loopRows[ri][f+'Ids'];
  const avail=elements.filter(e=>e.type===type&&!sel.includes(e.id));
  const rect=event.currentTarget.getBoundingClientRect();
  pp.innerHTML=`${!avail.length?`<div class="dp-empty">No hay m√°s ${TYPE_LABELS[type]}</div>`:''}
    ${avail.map(e=>`<div class="dp-item" onclick="addMs(${ri},'${f}',${e.id})">
      ${getElementIconSrc(e)?`<img src="${getElementIconSrc(e)}">`:'<div class="dp-ph">?</div>'}
      <span>${e.name}</span></div>`).join('')}`;
  posDD(pp,rect);
}

function posDD(pp,rect){
  pp.style.display='block';
  pp.style.left=rect.left+'px';
  pp.style.top=(rect.bottom+4)+'px';
  pp.style.minWidth=Math.max(160,rect.width)+'px';
}
function setSS(ri,f,id){loopRows[ri][f+'Id']=id; closeDD(); renderLoopRows();}
function addMs(ri,f,id){loopRows[ri][f+'Ids'].push(id); closeDD(); renderLoopRows();}
function closeDD(){document.getElementById('dropdownPopup').style.display='none';}
document.addEventListener('click',e=>{if(!e.target.closest('#dropdownPopup')&&!e.target.closest('.single-sel')&&!e.target.closest('.m-add-btn')) closeDD();});

function switchTab(name){
  document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active',['elements','loop'][i]===name));
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
}

// ==================== CANVAS ====================
function calcBoxW(n){return n?n*ITEM_W+(n-1)*4+BOX_PAD*2:0}

function calcLayout(side,row){
  const costs=row.costIds.map(id=>getElem(id)).filter(Boolean);
  const rewards=row.rewardIds.map(id=>getElem(id)).filter(Boolean);
  const hc=costs.length>0, ha=!!row.actionId, hr=rewards.length>0;
  const cw=calcBoxW(costs.length), rw=calcBoxW(rewards.length);
  const pg=PLAYER_R+14;

  if(side==='right'){
    let x=CX+pg;
    const sL=x, sR=x+NODE_S; x=sR+GAP;
    const cL=x, cR=hc?x+cw:x; if(hc) x=cR+GAP;
    const aL=x, aR=ha?x+NODE_S:x; if(ha) x=aR+GAP;
    const rL=x, rR=hr?x+rw:x;
    return {sL,sR,cL,cR,aL,aR,rL,rR,costs,rewards,hc,ha,hr};
  } else {
    let x=CX-pg;
    const sR=x, sL=x-NODE_S; x=sL-GAP;
    const cR=x, cL=hc?x-cw:x; if(hc) x=cL-GAP;
    const aR=x, aL=ha?x-NODE_S:x; if(ha) x=aL-GAP;
    const rR=x, rL=hr?x-rw:x;
    return {sL,sR,cL,cR,aL,aR,rL,rR,costs,rewards,hc,ha,hr};
  }
}

function renderCanvas(){
  const canvas=document.getElementById('gameCanvas');
  const ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,CANVAS_W,CANVAS_H);

  // White background
  ctx.fillStyle='#ffffff';
  ctx.fillRect(0,0,CANVAS_W,CANVAS_H);

  // Subtle dot grid
  ctx.fillStyle='rgba(0,0,0,0.035)';
  for(let x=50;x<CANVAS_W;x+=50)
    for(let y=TITLE_H+30;y<CANVAS_H;y+=50)
      ctx.fillRect(x,y,1.5,1.5);

  drawTitleBar(ctx);

  // Draw rows BEFORE player
  loopRows.forEach((row,i)=>{
    if(!row.enabled||!row.systemId) return;
    drawRow(ctx,row,ROW_CONFIGS[i]);
  });

  drawPlayer(ctx);
  drawLegend(ctx);
}

function drawTitleBar(ctx){
  // Light gray bar
  ctx.fillStyle='#f0f2f5';
  ctx.fillRect(0,0,CANVAS_W,TITLE_H);
  ctx.strokeStyle='#cccccc'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(0,TITLE_H); ctx.lineTo(CANVAS_W,TITLE_H); ctx.stroke();

  const gameName=(document.getElementById('gameName').value||'MY GAME').toUpperCase();

  // LEFT: game name
  ctx.font='bold 24px Orbitron,monospace';
  ctx.fillStyle='#1a1a2e';
  ctx.textAlign='left'; ctx.textBaseline='middle';
  ctx.fillText(gameName,28,TITLE_H/2);

  // RIGHT: small "DIAGRAM" above, "GAME LOOP" below
  ctx.textAlign='right';
  ctx.font='600 10px Rajdhani,sans-serif';
  ctx.fillStyle='#999';
  ctx.fillText('DIAGRAM',CANVAS_W-28,TITLE_H/2-11);
  ctx.font='bold 20px Orbitron,monospace';
  ctx.fillStyle='#1a1a2e';
  ctx.fillText('GAME LOOP',CANVAS_W-28,TITLE_H/2+9);
}

function drawPlayer(ctx){
  // White circle + black border
  ctx.save();
  ctx.shadowColor='rgba(0,0,0,0.15)'; ctx.shadowBlur=16;
  ctx.beginPath(); ctx.arc(CX,CY,PLAYER_R,0,Math.PI*2);
  ctx.fillStyle='#ffffff'; ctx.fill();
  ctx.restore();
  ctx.beginPath(); ctx.arc(CX,CY,PLAYER_R,0,Math.PI*2);
  ctx.strokeStyle=C_BLACK; ctx.lineWidth=2.5; ctx.stroke();

  // Avatar icon
  ctx.save();
  ctx.beginPath(); ctx.arc(CX,CY,PLAYER_R-3,0,Math.PI*2); ctx.clip();
  ctx.fillStyle='#e8f0fe'; ctx.fillRect(CX-PLAYER_R,CY-PLAYER_R,PLAYER_R*2,PLAYER_R*2);
  ctx.fillStyle=C_BLUE;
  ctx.beginPath(); ctx.arc(CX,CY-14,15,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(CX,CY+34,28,Math.PI,0); ctx.fill();
  ctx.restore();

  ctx.font='bold 12px Rajdhani,sans-serif';
  ctx.fillStyle='#333'; ctx.textAlign='center'; ctx.textBaseline='top';
  ctx.fillText('PLAYER',CX,CY+PLAYER_R+6);
}

function drawRow(ctx,row,cfg){
  const {side,y}=cfg;
  const l=calcLayout(side,row);
  const sysElem=getElem(row.systemId);
  const actElem=row.actionId?getElem(row.actionId):null;
  if(!sysElem) return;

  // Player ‚Üí System (solid black elbow)
  const pEdge=side==='right'?CX+PLAYER_R+2:CX-PLAYER_R-2;
  const sEdge=side==='right'?l.sL:l.sR;
  drawElbow(ctx,pEdge,CY,sEdge,y,C_BLACK,side);

  // System node (blue)
  const sCX=side==='right'?l.sL+NODE_S/2:l.sR-NODE_S/2;
  drawNode(ctx,sCX,y,sysElem,C_BLUE);

  // System ‚Üí Cost (red line)
  if(l.hc){
    const from=side==='right'?l.sR:l.sL;
    const to  =side==='right'?l.cL:l.cR;
    drawLineH(ctx,from,y,to,C_RED);
    drawBox(ctx,l.cL,y-BOX_H/2,calcBoxW(l.costs.length),BOX_H,l.costs,C_RED);
  }

  // Cost ‚Üí Action (black)
  if(l.ha){
    const from=l.hc?(side==='right'?l.cR:l.cL):(side==='right'?l.sR:l.sL);
    const to  =side==='right'?l.aL:l.aR;
    drawLineH(ctx,from,y,to,C_BLACK);
    const aCX=side==='right'?l.aL+NODE_S/2:l.aR-NODE_S/2;
    drawNode(ctx,aCX,y,actElem,C_AMBER);
  }

  // ‚Üí Reward (green line)
  if(l.hr){
    const prev=l.ha?(side==='right'?l.aR:l.aL):l.hc?(side==='right'?l.cR:l.cL):(side==='right'?l.sR:l.sL);
    const to  =side==='right'?l.rL:l.rR;
    drawLineH(ctx,prev,y,to,C_GREEN);
    drawBox(ctx,l.rL,y-BOX_H/2,calcBoxW(l.rewards.length),BOX_H,l.rewards,C_GREEN);

    // Return arrow: reward ‚Üí player (stops with margin, no canvas edge touch)
    const rewEdge=side==='right'?l.rR:l.rL;
    drawReturn(ctx,rewEdge,y,side,C_GREEN);
  }
}

// ---- ELBOW from player edge to system ----
function drawElbow(ctx,x1,y1,x2,y2,color,side){
  ctx.strokeStyle=color; ctx.lineWidth=2; ctx.setLineDash([]);
  if(Math.abs(y1-y2)<4){
    ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
    drawHead(ctx,x2,y2,x2>x1?0:Math.PI,color); return;
  }
  const midX=x1+(x2-x1)*0.45;
  ctx.beginPath();
  ctx.moveTo(x1,y1); ctx.lineTo(midX,y1); ctx.lineTo(midX,y2); ctx.lineTo(x2,y2);
  ctx.stroke();
  drawHead(ctx,x2,y2,x2>x1?0:Math.PI,color);
}

// ---- Horizontal line with arrowhead ----
function drawLineH(ctx,x1,y,x2,color){
  ctx.strokeStyle=color; ctx.fillStyle=color;
  ctx.lineWidth=2; ctx.setLineDash([]);
  ctx.beginPath(); ctx.moveTo(x1,y); ctx.lineTo(x2,y); ctx.stroke();
  drawHead(ctx,x2,y,x2>x1?0:Math.PI,color);
}

// ---- Return arrow (reward ‚Üí near player, no canvas wall) ----
function drawReturn(ctx,rewEdgeX,rowY,side,color){
  ctx.strokeStyle=color; ctx.fillStyle=color;
  ctx.lineWidth=2; ctx.setLineDash([]);

  // Outer lane: a few pixels inside canvas edge
  const lane=side==='right'?CANVAS_W-OUTER_MARGIN:OUTER_MARGIN;
  // Stop point: near player edge with extra margin
  const stopX=side==='right'?CX+PLAYER_R+PLAYER_STOP:CX-PLAYER_R-PLAYER_STOP;

  ctx.beginPath();
  ctx.moveTo(rewEdgeX,rowY);
  ctx.lineTo(lane,rowY);
  ctx.lineTo(lane,CY);
  ctx.lineTo(stopX,CY);
  ctx.stroke();
  drawHead(ctx,stopX,CY,side==='right'?Math.PI:0,color);
}

function drawHead(ctx,x,y,angle,color){
  const len=10,w=5;
  ctx.save(); ctx.fillStyle=color;
  ctx.translate(x,y); ctx.rotate(angle);
  ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(-len,-w); ctx.lineTo(-len,w);
  ctx.closePath(); ctx.fill(); ctx.restore();
}

// ---- Multi-icon box ----
function drawBox(ctx,x,y,w,h,items,stroke){
  ctx.save();
  ctx.shadowColor='rgba(0,0,0,0.1)'; ctx.shadowBlur=8;
  rr(ctx,x,y,w,h,10); ctx.fillStyle='#ffffff'; ctx.fill();
  ctx.restore();
  ctx.strokeStyle=stroke; ctx.lineWidth=2.5;
  rr(ctx,x,y,w,h,10); ctx.stroke();

  if(!items.length) return;
  const totalW=items.length*ICON_S+(items.length-1)*4;
  const sx=x+w/2-totalW/2;
  items.forEach((el,i)=>{
    const ix=sx+i*(ICON_S+4)+ICON_S/2, iy=y+h/2;
    if(el&&el.imgObj){
      drawImg(ctx,el.imgObj,ix-ICON_S/2,iy-ICON_S/2,ICON_S,ICON_S,8);
    } else {
      rr(ctx,ix-ICON_S/2,iy-ICON_S/2,ICON_S,ICON_S,8);
      ctx.fillStyle='rgba(0,0,0,0.05)'; ctx.fill();
      ctx.font='10px Rajdhani'; ctx.fillStyle='#888';
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText(el?el.name.substring(0,5):'?',ix,iy);
    }
  });
}

// ---- Node ----
function drawNode(ctx,cx,cy,elem,borderColor){
  ctx.save();
  ctx.shadowColor='rgba(0,0,0,0.1)'; ctx.shadowBlur=8;
  rr(ctx,cx-NODE_S/2,cy-NODE_S/2,NODE_S,NODE_S,12);
  ctx.fillStyle='#ffffff'; ctx.fill();
  ctx.restore();
  ctx.strokeStyle=borderColor; ctx.lineWidth=2.5;
  rr(ctx,cx-NODE_S/2,cy-NODE_S/2,NODE_S,NODE_S,12); ctx.stroke();

  if(elem.imgObj){
    drawImg(ctx,elem.imgObj,cx-ICON_S/2,cy-ICON_S/2,ICON_S,ICON_S,9);
  } else {
    ctx.font='700 9px Rajdhani'; ctx.fillStyle='#555';
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(elem.name.substring(0,8),cx,cy);
  }

  ctx.font='600 10px Rajdhani,sans-serif'; ctx.fillStyle='#444444';
  ctx.textAlign='center'; ctx.textBaseline='top';
  const lbl=elem.name.length>14?elem.name.substring(0,13)+'‚Ä¶':elem.name;
  ctx.fillText(lbl,cx,cy+NODE_S/2+4);
}

function drawImg(ctx,img,x,y,w,h,r){
  ctx.save(); rr(ctx,x,y,w,h,r); ctx.clip();
  ctx.drawImage(img,x,y,w,h); ctx.restore();
}

function rr(ctx,x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y); ctx.lineTo(x+w-r,y); ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r); ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h); ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r); ctx.quadraticCurveTo(x,y,x+r,y);
  ctx.closePath();
}

function drawLegend(ctx){
  const items=[
    {c:C_BLACK,  l:'Flujo del juego'},
    {c:C_RED,    l:'L√≠nea de Coste'},
    {c:C_GREEN,  l:'L√≠nea de Recompensa'},
    {c:C_BLUE,   l:'Sistema'},
    {c:C_AMBER,  l:'Acci√≥n'},
  ];
  const lx=24,ly=CANVAS_H-40,iw=148;
  ctx.fillStyle='rgba(245,246,248,0.95)';
  ctx.strokeStyle='#ccc'; ctx.lineWidth=1;
  rr(ctx,lx-8,ly-8,iw*items.length+16,30,5);
  ctx.fill(); ctx.stroke();
  items.forEach((it,i)=>{
    const ix=lx+i*iw;
    ctx.strokeStyle=it.c; ctx.lineWidth=2.5; ctx.setLineDash([]);
    ctx.beginPath(); ctx.moveTo(ix,ly+7); ctx.lineTo(ix+22,ly+7); ctx.stroke();
    ctx.fillStyle='#444'; ctx.font='600 11px Rajdhani,sans-serif';
    ctx.textAlign='left'; ctx.textBaseline='middle';
    ctx.fillText(it.l,ix+28,ly+7);
  });
}

// ==================== SCALE / DOWNLOAD ====================
function applyScale(){
  const s=Math.max(20,Math.min(150,parseInt(document.getElementById('scaleInput').value)||70))/100;
  const canvas=document.getElementById('gameCanvas');
  canvas.style.transform=`scale(${s})`;
  canvas.style.transformOrigin='top left';
}

function downloadCanvas(){
  const canvas=document.getElementById('gameCanvas');
  const a=document.createElement('a');
  const name=(document.getElementById('gameName').value||'game_loop').toLowerCase().replace(/\s+/g,'_');
  a.download=name+'_game_loop.png';
  a.href=canvas.toDataURL('image/png');
  a.click();
}

// ==================== INIT ====================
(async function init(){
  await loadDefaultElements();
  renderElementsTable();
  renderLoopRows();
  renderCanvas();
  applyScale();
})();
</script>
</body>
</html>
